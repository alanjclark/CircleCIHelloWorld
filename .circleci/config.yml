version: 2.1

orbs:
  mac: circleci/macos@2.0.0

jobs:
  permissions-check:

    macos:
      xcode: 13.1.0

    steps:
      - mac/add-permission:
          bundle-id: "com.apple.sshd"
          permission-type: "kTCCServiceScreenCapture"
      - run:
          name: Create screencapture directory
          command: mkdir -p ~/artifacts/screencapture
      - run:
          name: Capture Screen
          command: screencapture -x ~/artifacts/screencapture/screenshot.png
      - run:
          name: Set Ruby Version
          command: sed -i '' 's/^chruby.*/chruby ruby-2.6/g' ~/.bash_profile

      - run:
          name: Check Ruby Version
          command: ruby -v

      - mac/switch-ruby:
          version: "3.0"

      - run:
          name: Check Ruby Version Again
          command: ruby -v

      - store_artifacts:
          path: ~/artifacts
      - mac/list-permissions
      - mac/list-permission-types
             
workflows:
  version: 2
  build:
    jobs:
      - permissions-check
