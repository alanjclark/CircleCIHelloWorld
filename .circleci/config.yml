# For a detailed guide to building and testing on iOS, read the docs:
# https://circleci.com/docs/2.0/testing-ios/

version: 2.1

workflows:
  main_workflow:
    jobs:
      - checkout_and_build

constants:
  cache:
    - &spm_cache_key spm-cache-{{ arch }}-{{ .Branch }}-{{ checksum "./addedfile.txt" }}

jobs:
  checkout_and_build:
    macos:
      xcode: 12.5.1
    resource_class: m2.medium
    steps:
      - checkout
      - restore_spm_cache
      - create_logs_directory
      - create_derived_data_directory
      - save_spm_cache
      - persist_to_workspace:
          root: .
          paths:
            - "**/*"

commands:
  save_spm_cache:
    steps:
      - save_cache:
          paths:
            - SourcePackages/
          key: *spm_cache_key

  restore_spm_cache:
    steps:
      - restore_cache:
          key: *spm_cache_key

  create_logs_directory:
    steps:
      - run:
          name: Create log directory
          command: mkdir -p logs

  create_derived_data_directory:
    steps:
      - run:
          name: Create DerivedData directory
          command: mkdir DerivedData

  restore_derived_data_directory:
    steps:
      - run:
          name: Retrieve DerivedData directory
          command: cp -r /tmp/workspace/ .

