version: 2.1

orbs:
  mac: circleci/macos@2.0.0

jobs:
  permissions-check:

    macos:
      xcode: 13.1.0

    steps:

      - checkout

      - run:
          name: Granting Safari permissions and enabling safaridriver
          command: |
            epochdate=$(($(date +'%s * 1000 + %-N / 1000000')))
            macos_major_version=$(sw_vers -productVersion | awk -F. '{ print $1 }')
            tcc_service_accessibility="replace into access (service,client,client_type,auth_value,auth_reason,auth_version,indirect_object_identifier_type,indirect_object_identifier,flags,last_modified) values (\"kTCCServiceAccessibility\",\"/usr/sbin/sshd\",1,2,4,1,0,\"UNUSED\",0,$epochdate);"
            tcc_service_events="replace into access (service,client,client_type,auth_value,auth_reason,auth_version,indirect_object_identifier_type,indirect_object_identifier,flags,last_modified) values (\"kTCCServiceAppleEvents\",\"/usr/sbin/sshd\",1,2,4,1,0,\"com.apple.systemevents\",0,$epochdate);"
            sudo sqlite3 "/Library/Application Support/com.apple.TCC/TCC.db" "$tcc_service_accessibility"
            sudo sqlite3 "/Users/distiller/Library/Application Support/com.apple.TCC/TCC.db" "$tcc_service_accessibility"
            sudo sqlite3 "/Users/distiller/Library/Application Support/com.apple.TCC/TCC.db" "$tcc_service_events"
            sudo sqlite3 "/Library/Application Support/com.apple.TCC/TCC.db" "$tcc_service_events"
            osascript ./tmp.applescript
            sudo safaridriver --enable

      - run:
          name: Create screencapture directory
          command: mkdir -p ~/artifacts/screencapture
      - run:
          name: Capture Screen
          command: screencapture -x ~/artifacts/screencapture/screenshot.png
      - run:
          name: Set Ruby Version
          command: sed -i '' 's/^chruby.*/chruby ruby-2.6/g' ~/.bash_profile

      - run:
          name: Check Ruby Version
          command: ruby -v

      - mac/switch-ruby:
          version: "3.0"

      - run:
          name: Check Ruby Version Again
          command: ruby -v

      - store_artifacts:
          path: ~/artifacts
      - mac/list-permissions
      - mac/list-permission-types
             
workflows:
  version: 2
  build:
    jobs:
      - permissions-check
